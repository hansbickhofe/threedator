<!doctype html>
<html>

  <head>
    <title>threedator</title>
    <style>
      #A { width:600px;height:800px;cursor:pointer;background:#2f2f2f;position:absolute;top:10px;color:#fff;font:bold 15px Arial; }
      #B { width:103px;height:800px;cursor:pointer;background:#2f2f2f;position:absolute;top:10px;color:#fff;font:bold 15px Arial; }
      #C { width:180px;height:750px;cursor:pointer;background:#2f2f2f;position:absolute;top:60px;color:#fff;font:bold 10px Arial; }
      #X { width:80px;height:20px;cursor:pointer;background:#2f2f2f;position:absolute;top:10px;color:#fff;font:bold 15px Arial; }
      #Y { width:80px;height:20px;cursor:pointer;background:#2f2f2f;position:absolute;top:10px;color:#fff;font:bold 15px Arial; }
      #myimg { position: absolute; z-index: 1000; border-spacing: 0;}
    </style>
    <script src="js/socket.io-1.2.0.js"></script>
    <script src="js/jquery-1.11.1.js"></script>
  </head>
  <body>
    <div id="A" style="left:70px;"></div>
    <img src="dreieck.png" class="follow" id="myimg"/>
    <div id="B" style="left:700px;">
      LOGON:
      Playername<BR>
      <input type="text" size=10 id="login" value="PLAYERNAME"/>
      <br>
      Password<BR>
      <input type="password" size=10 id="password" />
      <br>
      <button id='logon'/>Logon</button><br><br>
      <hr>
      FIRE:
      ShipID<BR>
      <input type="text" size=5 id="shipid" value="1"/>
      <br>
      TargetID<BR>
      <input type="text" size=5 id="targetid" value="2"/>
      <br>
      <button id='fire'/>Fire</button><br><br>
      <hr>
      Pickup:
      ShipID<BR>
      <input type="text" size=5 id="playerid" />
      <br>
      TargetID<BR>
      <input type="text" size=5 id="kistenid" />
      <br>
      <button id='gotit'/>gotit</button><br><br>
    </div>

    <div id="C" style="left:830px;"></div>
    <div id="X" style="left:830px;"></div>
    <div id="Y" style="left:930px;"></div>
    <br>

    <script>
    var socket = io();
    var msg_counter = 0 ;
    var syncInputVal = function(msg){
        if (msg_counter >= 12 ) {
          $("#C").empty();
          msg_counter = 0 ;
        }

        $.each(msg,function(key,value){
          $("#C").append(key+' '+value+' <br>');
          });
        $("#C").append('<hr>');
        msg_counter++;

      }

    function angle(cx, cy, ex, ey) {
      var dy = ey - cy;
      var dx = ex - cx;
      var theta = Math.atan2(dy, dx); // range (-PI, PI]
      theta *= 180 / Math.PI; // rads to degs, range (-180, 180]
      //if (theta < 0) theta = 360 + theta; // range [0, 360)

      return theta;
    }

    function angle360(cx, cy, ex, ey) {
      var theta = angle(cx, cy, ex, ey); // range (-180, 180]
      if (theta < 0) theta = 360 + theta; // range [0, 360)

      return theta;
}

    $(document).ready(function(e) {

    $('#logon').click(function(e) {
      var sendlogon = {login: $('#login').val(), password: $('#password').val()};
      socket.emit('logon', sendlogon);
    });

    $('#fire').click(function(e) {
      var sendshot = {id: $('#shipid').val(), tid: $('#targetid').val(), time: 0};
      socket.emit('fire', sendshot);
    });

    $('#gotit').click(function(e) {
      var sendgotit = {p_id: $('#playerid').val(), k_id: $('#kistenid').val(), time: 0};
      socket.emit('gotit', sendgotit);
    });

    $('#A').click(function(e) {
      var lastpos = $("#myimg").position(); // returns an object with the attribute top and left
      lastpos.top;  // top offset position
      lastpos.left; // left offset position
      var posX = e.pageX ,posY = e.pageY;

      $("#X").text('X: '+posX)
      $("#Y").text('Y: '+posY)

      var sendpos = { id: $('#shipid').val(), posX: lastpos.left, posZ: lastpos.top, targetX: posX, targetZ: posY, time: 0};
      socket.emit('channelname', sendpos);
      //$('.follow').css({'top': e.clientY - 20, 'left': e.clientX - 20});

    });
    socket.on('channelname', function(msg){
      var rotation = angle360(msg.posX,msg.posZ,msg.targetX,msg.targetZ);
      console.log(rotation);
      $("#C").append(msg);

      $('.follow').animate({  borderSpacing: -90 }, {
        step: function(now,fx) {
          $('.follow').css('-webkit-transform','rotate('+rotation+')');
          $('.follow').css('-moz-transform','rotate('+rotation+')');
          $('.follow').css('transform','rotate('+rotation+')');
        },
        duration:'slow'
      },'linear');

      $('.follow').animate({'top': msg.targetZ - 20, 'left': msg.targetX - 20},1500);

      syncInputVal(msg);
    });

    socket.on('fire', function(msg){
      $("#C").append(msg);
      syncInputVal(msg);
    });

    socket.on('muni', function(msg){
      $("#C").append(msg);
      syncInputVal(msg);
    });

    socket.on('logonnack', function(msg){
      $("#C").append(msg);
      syncInputVal(msg);
    });

    socket.on('logonack', function(msg){
      $("#C").append(msg);
      syncInputVal(msg);
    });
});
    </script>
  </body>

</html>
